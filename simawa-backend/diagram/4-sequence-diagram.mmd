%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e8f5e9', 'primaryTextColor': '#1b5e20', 'primaryBorderColor': '#4caf50', 'lineColor': '#2e7d32', 'actorLineColor': '#4caf50'}}}%%

sequenceDiagram
    autonumber
    
    participant U as ðŸ‘¤ User
    participant FE as ðŸ–¥ï¸ Frontend (Next.js)
    participant API as âš™ï¸ Backend (Go/Gin)
    participant Auth as ðŸ” Auth Service
    participant DB as ðŸ—„ï¸ PostgreSQL
    participant Minio as ðŸ“¦ MinIO Storage
    participant Redis as ðŸ’¾ Redis Cache
    
    Note over U,Redis: ðŸ” Flow Login
    U->>FE: Buka halaman login
    FE->>U: Tampilkan form login
    U->>FE: Submit email & password
    FE->>API: POST /auth/login
    API->>Auth: Validasi credentials
    Auth->>DB: Query user by email
    DB-->>Auth: User data
    Auth->>Auth: Verify password hash
    Auth->>Auth: Generate JWT tokens
    Auth->>Redis: Store refresh token
    Auth-->>API: Access + Refresh token
    API-->>FE: Token response
    FE->>FE: Store in NextAuth session
    FE-->>U: Redirect ke dashboard
    
    Note over U,Redis: ðŸ“§ Flow Buat Surat
    U->>FE: Klik "Buat Surat"
    FE->>API: GET /v1/orgs (with JWT)
    API->>Auth: Validate JWT
    Auth-->>API: User ID + Roles
    API->>DB: Query organizations
    DB-->>API: List organizations
    API-->>FE: Organizations data
    FE-->>U: Tampilkan form surat
    
    U->>FE: Isi form + upload logo
    U->>FE: Klik "Preview"
    FE->>API: POST /v1/surat/preview
    API->>API: Generate PDF
    API-->>FE: PDF blob
    FE-->>U: Tampilkan PDF preview
    
    U->>FE: Klik "Submit"
    FE->>API: POST /v1/surat
    API->>API: Generate final PDF
    API->>Minio: Upload PDF file
    Minio-->>API: File key
    API->>DB: Save surat metadata
    DB-->>API: Surat ID
    API-->>FE: Surat created
    
    FE->>API: POST /v1/surat/:id/submit
    API->>DB: Update status to PENDING
    API->>DB: Create notification for admin
    API-->>FE: Success
    FE-->>U: Notifikasi sukses
    
    Note over U,Redis: âœ… Flow Approval Surat
    U->>FE: Admin buka inbox surat
    FE->>API: GET /v1/surat/inbox
    API->>DB: Query pending surat
    DB-->>API: List surat
    API-->>FE: Surat data
    FE-->>U: Tampilkan list surat
    
    U->>FE: Klik approve/reject
    FE->>API: POST /v1/surat/:id/approve
    API->>DB: Update status
    API->>DB: Create notification for creator
    API-->>FE: Success
    FE-->>U: Notifikasi sukses
